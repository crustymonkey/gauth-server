# gauth-server
A TOTP server for creating and verifying TOTP keys.

## Create the Database and Config
The first thing you should do is create your database within Postgres.  Postgres
setup and configuration is beyond the scope of this document.

Once you have the database created and a user for that db, you can create
the necessary table structure using the `db.sql` file.

```bash
psql -h <host> -U <user> -p <port> < db.sql
```

After that's ready, be sure to create a config file for your server.  You
can use the included `config.ini.default` as a guide for this.  The default
location that the gauth server will look for this file is
`/etc/gauth/config.ini`, but you can override this on the command-line
with the `-c/--config <PATH>` option.

## Create an API Key
Next, you'll need to create an API key to use.  You can do this using the
server binary with the `-a/--create-api-key <HOST>` option.  For example:

```bash
gauth-server -a host.example.com
```

This will create an API key to use with the server and store the hostname with
it for reference.  It's worth noting that the hostname is only there as metadata
and is not part of the authentication of the API client.

## Start the Server
You can then start the server up.  If you are storing the config in a location
other than the default, your command would look like:

```bash
gauth-server --config /path/to/config.ini
```

## The API
With your server up and running, you can start using it immediately. For
example purposes, we'll say that your server is going to be bound to
`localhost:8000`.

All the requests are done via HTTP POST request with a JSON payload. In the examples below, I'll use [httpie](https://httpie.io/) as it's a bit more user-friendly than `curl` is.

### /create
Creating a token is as simple as calling your API server with the following payload:

```json
{
    "api_key": "abc123",
    "ident": "key identifier"
}
```

Your response will look like:

```json
{
    "status": true|false,
    "ident": "key identifier",
    "secret": "ABC123"
}
```

An example request with [httpie](https://httpie.io/):

```bash
http -j --follow localhost:8000/create api_key=abc123 ident=test
```

### /qr
You can use this API to get an SVG string representing the qr code that
you can then display to the user.  The API payload is:

```json
{
    "api_key": "abc123",
    "ident": "key identifier",
    "name": "company name or whatever",
    "title": "title for the qr code"
}
```

And your response will be:

```json
{
    "status": true|false,
    "qr_code": "SVG string"
}
```

An example request:

```bash
http -j --follow localhost:9005/qr api_key=abc123 ident=test name=Company title=testing
```

Note that you can change the default width and height for this image in your config file.

### /qr_url
This works very similarly to `/qr`, but will return a link to a google charts qr code.  The API is basically the same as `/qr`:

```json
{
    "api_key": "abc123",
    "ident": "key identifier",
    "name": "company name or whatever",
    "title": "title for the qr code"
}
```

And your response will be:

```json
{
    "status": true|false,
    "qr_code_url": "https://chart.googleapis.com/chart?..."
}
```

An example request:

```bash
http -j --follow localhost:9005/qr_url api_key=abc123 ident=test name=Company title=testing
```

Note that you can change the default width and height for this image in your config file.

### /verify
This is the API used to verify the 6 digit code generated by a TOTP app
like Google-authenticator or Authy.  The API is quite simple:

```json
{
    "api_key": "abc123",
    "ident": "key identifier",
    "code": 123456
}
```

And your response will be:

```json
{
    "status": true|false,
    "verified": true|false
}
```

An example request:

```bash
http -j --follow localhost:9005/verify api_key=abc123 ident=test code=123456
```

# TODO
* There's some cleanup that needs to be done to handle some errors and return them as pure JSON responses, rather than the current mix of `status: false` and HTTP errors.